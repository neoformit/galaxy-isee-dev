<tool id="interactive_tool_isee" tool_type="interactive" name="iSEE" version="0.0.1">
  <requirements>
    <container type="docker">neoformit/galaxy-isee-it</container>
  </requirements>

  <entry_points>
    <entry_point name="iSEE Single Cell Visualisation" requires_domain="True">
      <!-- This port is exposed by the docker container -->
      <port>8888</port>
    </entry_point>
  </entry_points>

  <command><![CDATA[

## Container wdir: /import

#set INPUT_PATH = "sce"
#set RSCRIPT = '/scripts/isee.R'

ln -s '$input.extra_files_path' '$INPUT_PATH' &&
ln -s '$isee_script' '$RSCRIPT' &&
cp '$isee_script' '$outfile' &&

## Redirect stderr - unfortunately necessary to stop R "warning" messages from
## inferring job status as "failed"
/scripts/run.sh '$RSCRIPT'

  ]]>
  </command>

  <configfiles>
    <configfile name="isee_script"><![CDATA[

## Import render function to template R Shiny app code
## -----------------------------------------------------------------------------
#import os
#import importlib.util
#set modpath = $os.path.join($__tool_directory__, "isee_render.py")
#set spec = $importlib.util.spec_from_file_location("isee_render", $modpath)
#set render = $importlib.util.module_from_spec(spec)
#$spec.loader.exec_module(render)


## Stop warning messages being emitted from R while still allowing genuine job failure
## -----------------------------------------------------------------------------
devNull <- file("/dev/null", open = "wt")
sink(devNull, type = "message")


## Begin R script
## -----------------------------------------------------------------------------

library(iSEE)
library(HDF5Array)

sce_path <- 'sce'
sce <- loadHDF5SummarizedExperiment(sce_path)

$render.app($custom)

shiny::runApp(app, host="0.0.0.0", port=8888, quiet=TRUE)

]]></configfile>
  </configfiles>

  <inputs>
    <param
      name="input"
      type="data"
      format="rdata.se"
      label="HDF5SummarizedExperiment: rdata.se (composite)"
      help="This datatype represents a HDF5SummarizedExperiment object as
        exported from R."
    />

    <!-- THIS BLOCK IN DEVELOPMENT - CURRENTLY HIDDEN FROM USERS -->
    <conditional name="custom">
      <param name="selected" label="Customize iSEE display" type="boolean" hidden="true"/>

      <when value="true">

        <conditional name="method">
          <param name="selected" label="Method" type="select">
            <option value="choice" selected="true"> Choice of plots </option>
            <option value="custom"> Custom R configuration </option>
          </param>

          <when value="choice">
            <!-- Choices to go here as repeat (plots) and select (colors) -->
            <!-- Not sure about "extras" -->

            <!-- Need to define choice of plots with options for each -->
            <!-- And a set of colormaps -->

            <repeat name="plots" title="Initial plots">
              <param name="plot_type" type="select" label="Plot type">
                <option value="reduced_dimension_plot">Reduced dimension plot</option>
                <option value="feature_assay_plot">Feature assay plot</option>
                <option value="column_data_plot">Column data plot</option>
                <option value="row_data_table">Row data table</option>
                <option value="column_data_table">Column data table</option>
                <option value="row_data_plot">Row data plot</option>
                <option value="sample_assay_plot">Sample assay plot</option>
                <option value="complex_heatmap_plot">Complex heatmap plot</option>
              </param>

              <param name="pw" type="select" label="Plot width"
                  help="A width of 12 fills an entire row">
                <option value="2">2</option>
                <option value="4">4</option>
                <option value="6" selected="true">6</option>
                <option value="8">8</option>
                <option value="10">10</option>
                <option value="12">12</option>
              </param>
            </repeat>
          </when>

          <when value="custom">
            <param
              name="isee_params"
              type="data"
              format="txt"
              label="iSEE parameters"
              help="Pass arbitrary keyword arguments to iSEE().
                In order to use this field, please upload a text dataset containing
                valid R code (you may wish to use the paste function to upload)."
              />
          </when>
        </conditional>

      </when>
    </conditional>
  </inputs>

  <outputs>
    <data name="outfile" format="txt"
          label="${tool.name} on ${on_string}: Rscript" />
  </outputs>

  <tests>
  </tests>

  <help><![CDATA[

**Overview**

iSEE provides a web interface for visualising single-cell transcriptomic
datasets encapsulated in an HDF5SummarizedExperiment object.

-----

**Input**

The tool takes a single HDF5SummarizedExperiment object as an input,
which can be uploaded with the composite datatype ``rdata.se``. This requires
two input files: ``se.rds`` and ``assays.h5``. Within R, an
``HDF5SummarizedExperiment`` object can be exported as a directory containing
these two input files with the function ``saveHDF5SummarizedExperiment()``.
These utilities can be installed and imported within R from the ``HDF5Array``
package.

-----

**Useful links:**

- iSEE documentation:

  https://isee.github.io/iSEE/

- Documentation on ``HDF5SummarizedExperiment`` data object:

  https://rdrr.io/bioc/HDF5Array/man/saveHDF5SummarizedExperiment.html

- HDF5Array manual:

  https://bioc.ism.ac.jp/packages/3.7/bioc/manuals/HDF5Array/man/HDF5Array.pdf

]]></help>

  <citations>
    <citation type="bibtex">
      @article{rue2018isee,
        title={iSEE: interactive summarizedexperiment explorer},
        author={Rue-Albrecht, Kevin and Marini, Federico and Soneson,
          Charlotte and Lun, Aaron TL},
        journal={F1000Research},
        volume={7},
        year={2018},
        publisher={Faculty of 1000 Ltd}
      }
    </citation>
  </citations>
</tool>
